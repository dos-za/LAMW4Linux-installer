#!/bin/bash
#-------------------------------------------------------------------------------------------------#
#Universidade federal de Mato Grosso (Alma Mater)
#Course: Science Computer
#Version: 0.3.3
#Date: 10/15/2019
#Description:The "lamw_manager" is part of the core of LAMW Manager. This script is a wrapper for "core/lamw-instal.sh"
#-------------------------------------------------------------------------------------------------#

export DEBUG=0
export ARGS="$*"
export LAMW_MGR_INSTALL="core/lamw-install.sh"
export LAMW_MGR_CORE=""
export USE_PKEXEC=0
export ENTER_TO_EXIT=0
export CALL_BASH="bash"
export EXIT_STATUS=0

#Get Directory of LAMW Manager Core
if [ -e "$PWD/$LAMW_MGR_INSTALL" ]; then
	export LAMW_MGR_CORE="$PWD"
else
	export LAMW_MGR_CORE=$0
	export LAMW_MGR_CORE=${LAMW_MGR_CORE%/lamw_manager*} 
fi

export LAMW_MGR_INSTALL="$LAMW_MGR_CORE/$LAMW_MGR_INSTALL"
source $LAMW_MGR_CORE/core/common-shell.sh

#Del lamw-overrides
DelTempFiles(){ 
	if [ -e /tmp/lamw-overrides.conf ];then rm /tmp/lamw-overrides.conf ;fi
}

#Check if $USER is a sudo member 
CheckUserIsSudo(){
	cat /etc/group | grep sudo | grep $USER > /dev/null
	if [ $? != 0 ]; then 
		export USE_PKEXEC=1
	fi
}

CheckFlags(){
	newPtr ref_flag="$1"
	flagFind=$2
	echo "$ARGS" | grep "$flagFind" > /dev/null
	if [ $? = 0 ]; then 
		export ref_flag=1
		export ARGS=${ARGS//$flagFind/} # remove todas as ocorrencias de DEBUG=1
	fi
}

#Check if DEBUG flag is set 
getBashCMD(){
	if [ $DEBUG = 1 ]; then
		export CALL_BASH="$CALL_BASH -x"
	fi
}

#Run LAMW Manager as sudo (default)
RunAsSudo(){
	sudo -i $CALL_BASH "$LAMW_MGR_INSTALL" $*
	export EXIT_STATUS=$?
}

#Run LAMW Manager as Police Kit
RunAsPolkit(){
	pkexec env DISPLAY=$DISPLAY XAUTHORITY=$XAUTHORITY  $CALL_BASH "$LAMW_MGR_INSTALL" $*
	export EXIT_STATUS=$?
	if [  $ENTER_TO_EXIT = 1 ]; then
		echo "press enter to exit ...";read
	fi
}

#Wrapper function to Run LAMW Manager
Run(){
	echo "$USER" > /tmp/lamw-overrides.conf
	getBashCMD
	if [ $USE_PKEXEC = 1 ]; then
		RunAsPolkit $*
	else
		RunAsSudo $*
	fi
}

#main function
main(){
	IsUserRoot "lamw_manager"
	CheckFlags DEBUG "DEBUG=1"
	CheckFlags USE_PKEXEC "PKEXEC=1"
	CheckFlags ENTER_TO_EXIT "ENTER=1"
	CheckUserIsSudo
	Run $ARGS
	DelTempFiles
}
main $*
exit $EXIT_STATUS 