#!/bin/bash
#-------------------------------------------------------------------------------------------------#
#Universidade federal de Mato Grosso (Alma Mater)
#Course: Science Computer
#Version: 0.3.3
#Date: 10/14/2019
#Description:The "lamw_manager" is part of the core of LAMW Manager. This script is a wrapper for "core/lamw-instal.sh"
#-------------------------------------------------------------------------------------------------#

export DEBUG=0
export ARGS="$*"
export LAMW_MGR_INSTALL="core/lamw-install.sh"
export LAMW_MGR_CORE=""
export USE_PKEXEC=0
export ENTER_TO_EXIT=0
export CALL_BASH="bash"
export EXIT_STATUS=0


if  [  "$(whoami)" = "root" ];then #impede que o script seja executado pelo root 
	echo "Error: this version  of LAMW4Linux was designed  to run without root priveleges" >&2 # >&2 is a file descriptor to /dev/stderror
	echo "Exiting ..."
	exit 1
fi

#Get Directory of LAMW Manager Core
GetLmgrCorePath(){
	if [ -e "$PWD/$LAMW_MGR_INSTALL" ]; then
		export LAMW_MGR_CORE="$PWD/$LAMW_MGR_INSTALL"
	else
		export LAMW_MGR_CORE=$0
		export LAMW_MGR_CORE=${LAMW_MGR_CORE%/lamw_manager*} 
		export LAMW_MGR_CORE=$LAMW_MGR_CORE/$LAMW_MGR_INSTALL
	fi
}

#Del lamw-overrides
DelTempFiles(){
	if [ -e /tmp/lamw-overrides.conf ];then
		rm /tmp/lamw-overrides.conf
	fi
}

#Check if $USER is a sudo member 
CheckUserIsSudo(){
	cat /etc/group | grep sudo | grep $USER > /dev/null
	if [ $? != 0 ]; then 
		export USE_PKEXEC=1
	fi
}

#Check if PKEXEC flag is set 
CheckFlagPKexec(){
	echo "$ARGS" | grep "PKEXEC=1" > /dev/null
	if [ $? = 0 ]; then 
		export USE_PKEXEC=1
		export ARGS=${ARGS//PKEXEC=1/} # remove todas as ocorrencias de DEBUG=1
	fi
}

#Check if DEBUG flag is set 
CheckFlagDebug(){
	echo "$ARGS" | grep DEBUG=1 > /dev/null 
	if [ $? = 0 ]; then
		export DEBUG=1;
		export ARGS=${ARGS//DEBUG=1/} # remove todas as ocorrencias de DEBUG=1
		export CALL_BASH="$CALL_BASH -x"
	fi
}


#Check Enter flag is set (this flag is a GUI flag)
CheckFlagEnter(){
	echo "$ARGS" | grep "ENTER=1" > /dev/null 
	if [ $? = 0 ]; then
		export ENTER_TO_EXIT=1;
		export ARGS=${ARGS//ENTER=1/} # remove todas as ocorrencias de DEBUG=1
	fi
}

#Run LAMW Manager as Police Kit
RunAsPolkit(){
	echo "$USER" > /tmp/lamw-overrides.conf
	pkexec env DISPLAY=$DISPLAY XAUTHORITY=$XAUTHORITY  $CALL_BASH "$LAMW_MGR_CORE" $*
	export EXIT_STATUS=$?
	if [  $ENTER_TO_EXIT = 1 ]; then
		echo "press enter to exit ...";read
	fi
}

#Run LAMW Manager as sudo (default)
RunAsSudo(){
	echo "$USER" > /tmp/lamw-overrides.conf
	sudo -i $CALL_BASH "$LAMW_MGR_CORE" $*
	export EXIT_STATUS=$?
}

#Wrapper function to Run LAMW Manager
Run(){
	if [ $USE_PKEXEC = 1 ]; then
		RunAsPolkit $*
	else
		RunAsSudo $*
	fi
}
#main function
main(){
	GetLmgrCorePath
	CheckFlagDebug
	CheckFlagPKexec
	CheckFlagEnter
	CheckUserIsSudo
	Run $ARGS
	DelTempFiles
}

main $*
exit $EXIT_STATUS